//var data = {"mx140-gobernadores": {"@presidenciamx": 188, "productores": 176, "inauguraci\u00f3n": 142, "#morelos": 544, "estudiantes": 159, "#puebla": 423, "#quintanaroo": 197, "motivo": 217, "#m\u00e9xico": 234, "@goboax": 148, "inversi\u00f3n": 374, "felicitaci\u00f3n": 141, "nacional": 374, "#yucat\u00e1n": 197, "@epn": 291, "inauguramos": 186, "justicia": 158, "educaci\u00f3n": 207, "seguridad": 223, "familias": 208, "#oaxaca": 143, "salud": 194, "entregamos": 161, "2015": 201, "@gobyucatan": 242, "j\u00f3venes": 181, "acciones": 187, "desarrollo": 182, "desde": 194, "cultura": 147}, "mx140-pri": {"@ccq_pri": 76, "#pri": 474, "camacho": 41, "#puebla": 407, "#consolidandoliderazgos": 31, "c\u00e9sar": 26, "@chiapaspri": 24, "@ralbores": 47, "chapo": 36, "electoral": 27, "nacional": 27, "fuga": 33, "sobre": 23, "@epn": 35, "2015": 36, "@pri_nacional": 31, "@enc_icadep": 28, "chiapas": 33, "@manuelherrera1": 53, "partido": 24, "#19dejulio": 27, "#rojosdecoraz\u00f3n": 40, "j\u00f3venes": 37, "l\u00edder": 27, "#chiapas": 28, "@gdeloya": 38, "@cristina_diaz_s": 34, "puebla": 51, "#votapri": 38, "@ivonneop": 27}, "puebla140": {"@ssptm_puebla": 124, "escribe": 124, "ciudad": 130, "#lom\u00e1sle\u00eddo": 156, "#pueblaesmidestino": 199, "#opini\u00f3n": 161, "#efectoultra925": 150, "chapo": 242, "#monitoreodemedios": 134, "electoral": 135, "@rafagobernador": 191, "atlixco": 113, "2015": 238, "#pueblatv": 138, "campa\u00f1a": 112, "obras": 128, "valle": 159, "#particicpa": 213, "@tonygali": 122, "puebla": 770, "hasta": 157, "chalchihuapan": 142, "desde": 180}, "mx140-prd": {"@senbarbosa": 47, "@manceramiguelmx": 42, "#prd": 47, "@mario_delgado1": 44, "@dolores_pl": 70, "#paraestarbien": 67, "@riospiterjaguar": 46, "federal": 34, "@benjaminroblesm": 44, "fuga": 34, "prensa": 47, "sobre": 92, "#prd_df": 83, "@prdchisoficial": 60, "presidencia": 40, "@silvano_a": 42, "municipal": 66, "chiapas": 77, "seguridad": 36, "@navarretecarlos": 85, "@angelicadelap": 81, "comisi\u00f3n": 57, "#fotos": 33, "#chiapas": 50, "#prdcercadeti": 60, "@prdmexico": 138, "#cdmx": 105, "ciudadan\u00eda": 52, "#votaprd": 77, "@raulflorescoy": 170}, "mx140-ejecutivo": {"#ahorrarenerg\u00eda": 179, "cuesti\u00f3n": 180, "atenci\u00f3n": 236, "orientaci\u00f3n": 183, "h\u00e1bitos": 181, "#d\u00edadel\u00e1rbol": 118, "#to2015": 355, "ante": 128, "estos": 210, "#m\u00e9xico": 499, "#veracruz": 148, "sobre": 290, "@epn": 283, "diferencia": 184, "siguiendo": 180, "@indesol": 124, "seguridad": 125, "2015": 373, "sistema": 140, "usuarios": 172, "@conabio": 211, "@sinhambremx": 190, "convocatoria": 130, "social": 160, "#cfetips": 179}, "mx140-pan": {"@marianagc": 27, "pide": 25, "#avisosparroquiales": 23, "guzm\u00e1n": 29, "@pancho_burquez_": 52, "dirigencia": 32, "#pan": 255, "@javier_corral": 105, "ricardo": 31, "#larebeliondelasbases": 36, "@ricardoanayac": 34, "chapo": 68, "nacional": 56, "contra": 24, "fuga": 47, "@gabycuevas": 28, "sobre": 69, "@epn": 30, "@jlozanoa": 58, "@jlavallemaury": 26, "registro": 25, "corrupci\u00f3n": 25, "seguridad": 34, "@laura_rojas_": 32, "@lopezbrito_": 30, "comisi\u00f3n": 24, "anaya": 61, "corral": 30, "@yoxjavier": 40, "desde": 25}, "all": {"#ent\u00e9rate": 128, "guzm\u00e1n": 239, "#puebla": 250, "@javier_corral": 108, "joan": 194, "#m\u00e9xico": 116, "@enfoquenoticias": 157, "@osoriochong": 121, "chapo": 922, "nuclear": 112, "nacional": 184, "contra": 113, "fuga": 614, "sobre": 320, "@epn": 111, "2015": 133, "t\u00fanel": 129, "#opini\u00f3n": 111, "osorio": 129, "corrupci\u00f3n": 111, "seguridad": 256, "francia": 131, "#elchapo": 135, "rubido": 124, "#envivo": 123, "puebla": 143, "hasta": 106, "desde": 120, "tras": 113, "sebastian": 186}, "mx140-opinion": {"escap\u00f3": 128, "#ent\u00e9rate": 220, "trump": 154, "guzm\u00e1n": 246, "joan": 150, "#opini\u00f3n": 152, "chapo": 1131, "nuclear": 108, "altiplano": 138, "nacional": 110, "contra": 164, "fuga": 757, "@adela_micha": 116, "sobre": 358, "@epn": 177, "t\u00fanel": 177, "@enfoquenoticias": 288, "osorio": 114, "corrupci\u00f3n": 109, "seguridad": 230, "francia": 136, "grecia": 122, "#elchapo": 228, "#envivo": 135, "#quenosetepase": 112, "pe\u00f1a": 131, "desde": 127, "tras": 164, "sebastian": 145, "penal": 139}, "mx140-senadores": {"#laordenfueabatir": 133, "@marianagc": 153, "permanente": 126, "@silvia_garza": 125, "mucho": 108, "ciudad": 92, "#puebla": 134, "@javier_corral": 180, "#m\u00e9xico": 117, "nacional": 152, "contra": 91, "@epigmenioibarra": 201, "sobre": 413, "@epn": 100, "@jlozanoa": 97, "porque": 193, "#paraepnpidocastigo": 134, "mujeres": 98, "seguridad": 122, "#oaxaca": 106, "comisi\u00f3n": 237, "@el_universal_mx": 95, "ayotzinapafueelejercito": 174, "niperdonniolvido": 174, "desde": 137, "@hectoryunes": 117}, "mx140-diputados": {"@martibatres": 102, "@manceramiguelmx": 103, "mucho": 117, "#pan": 133, "@javier_corral": 201, "siempre": 95, "@ricardoanayac": 105, "@landyberzunza": 155, "federal": 121, "#juntosavanzamos": 96, "contra": 133, "fuga": 160, "@mx_diputados": 88, "mujeres": 216, "#oaxaca": 120, "@conchitadiez": 88, "@accionnacional": 87, "casa": 90, "@ferbelaunzaran": 450, "@ricardomeb": 123, "@yoxjavier": 156, "desde": 150}};
/*var data = $.getJSON( "data/pack.json", function( data ) {
    console.log("success...")
    console.log (data.puebla140)
    });
*/
var diameter = 650;
var newcat = "mx140-opinion";
var state1 = true;
var state2 = true;
var state3 = true;

// create chart svg space
var svg = d3.select('svg')
	.attr('width', diameter+100)
	.attr('height', diameter)
    .attr('margin-top', 200);

// define the omnitooltip
var tooltip = d3.select("body")
    .append("div")
    .attr('id', 'tooltip')
    .style("position", "absolute")
    .style("z-index", "10")
    .style("visibility", "hidden")
    .style("color", "white")
    .style("padding", "8px")
    .style("background-color", "rgba(0, 0, 0, 0.75)")
    .style("border-radius", "6px")
    .style("font", "2em SF Movie Poster")
    .text(":)");

// invoke pack layout and misterious filtering
var bubble = d3.layout.pack()
    .sort(compa)
	.size([diameter, diameter])
	.padding(4) // padding between adjacent circles
	.value(function(d) {return d.size;}); // new data will be loaded to bubble layout



// ---------------- ---------------- DRAW BUBBLES ----------------- --------------//
function drawBubbles(newcat){
    var bop = svg.selectAll('g')
        .data({}, function(d) {return d;});
        bop.exit().remove();


    var nodes = bubble.nodes(processData(data[newcat]))
	    .filter(function(d) { return !d.children; }); // filter out the outer bubble 
    console.log(data[newcat]);

    //create groups for each, append circle and text
    var vis = svg.selectAll('g')
	    .data(nodes, function(d) {return d.name;})
	    .enter().append('g')
        .attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });

    vis.append('circle') 
	    //.attr('r',0)
        .attr('value', function(d) { return 1.05*d.r+((Math.random()-0.5) * 20); }) //this is the random traslaper
	    .attr('class', function(d) { return sizeToClass(d.value); })
        .attr('opacity', 0)
        .attr('catname', function(d) { return d.name; })
        .on("mouseover", function(d) {
            tooltip.text(d.name + ": " + d.value);
            tooltip.style("visibility", "visible");
        })
        .on("mousemove", function() {
            return tooltip.style("top", (d3.event.pageY-20)+"px").style("left",(d3.event.pageX+10)+"px");
        })
        .on("mouseout", function(){return tooltip.style("visibility", "hidden");
        });

    vis.append("text")
        .attr("dy", ".3em")
        .attr('class', function(d) { return sizeToClass(d.value); })
        .attr('opacity', 0)
        .style("text-anchor", "middle")
        .style("stroke", "5px")
        .style("fill", "#FFFFFF")
        .style("pointer-events", "none")
        .text(function(d) { return d.name; });
    // add the div containers for tooltips with custom content
    vis.append("div")
        .attr("class", "hidden")
        .text(function(d) { return tts[newcat][d.name]; });
    
    //$('circle').animate().toggle().toggle();
    $('circle').each(function() {
        var nr = $(this).attr('value');
        $(this).animate({
            r: nr,
            opacity: 0.80
            }, {
                duration: Math.random()*2100,
                step: function(now){
                        // others are cool and go throu this
                        $(this).attr('r', now);
                        // firefox is stupid and need this
                        $(this).attr('r', nr);
                    }
            });
    });

    //anima el aumento de opacidad del texto
    $('text').animate({
            opacity: 1,
    }, 1000+Math.random()*1300);

    // then create the ubertooltips
    $("circle").each(function(){
        $(this).qtip({
            show: 'click',
            hide:'unfocus',
            title: 'catname',
            content:{
                text: $(this).siblings('div').text()
            },
            style: {
                classes: 'qtip-rounded qtip-shadow qtip-mx',
                opacity: 0.8,
            },
            position: {
                my: 'center left',  // Position my top left...
                at: 'center right', // at the bottom right of...
                target: $(this) // my target
            }
        })
    })
};




// ---------------- ---------------- FUNCTIONS ----------------- --------------//
function compa(a, b) {
  return (Math.random()*Math.random()-0.5);
}


function processData(pata) {
	var obj = pata;
	var newDataSet = []; 
    //console.log(pata);
	for(var prop in obj) {
		newDataSet.push({name: prop, className: prop.toLowerCase(), size: obj[prop]});
	}
	console.log("[:P]: "+obj);
    //console.log(newDataSet);
	return {children: newDataSet};
}


function changeCategory() {
    newcat = document.getElementById("categoria").value;
    console.log('[Updating to]: ' + newcat);
    drawBubbles(newcat);
    }



function sizeToClass(ra){
    if (ra < 100) return "burb1";
    if (ra>=100 && ra < 200) return "burb2";
    if (ra>=200 && ra < 300) return "burb3";
    if (ra>=300 && ra < 400) return "burb4";
    if (ra>=400 && ra < 500) return "burb5";
    if (ra>=500) return "burb6";
    else return "burb0";
}



// ---------------- ---------------- MAIN ----------------- --------------//
var main = function (){
    
    drawBubbles(newcat);

    // draw the colorstrip below nav
    $('#colorstrip').colorstrip({
        minInterval: 2000,
        maxInterval: 11000,
        minWidth: 20,
        maxWidth: 60,
        opacity: 0.5,
        //colors: ['#f90', '#39c', '#c00', '#090', '#c3f', '#007', '#69f']
        //colors: ['#FFD7C0', '#FFA67B', '#FF6446', '#D3D3D2', '#8C8C8B' ,'#B6B7B5']
        colors: ['#8C8C8B', '#FF6446', '#D3D3D2', '#FFA67B', '#FF6446']
    });

    // click on nav event handler
    $(".selec").on('click', function(e){
        e.preventDefault();
        //$(this).tab('show');
        var categ = $(this).attr('value');
        console.log('[Updating to]: ' + categ);
        drawBubbles(categ);
    });
 
    // slider button 1
    $("#toggle-slide-button-1").on('click',function () {
        if (state1){
            $('#navBtn-a').animate({right: 40}, 100);
            $('#navBtn-a').animate({width: 230}, 100);
            $("#panela" ).position({
                my: "center-50 top+2",
                at: "center top",
                of: "#navBtn-a"
            });
            $( "#panela" ).animate( {opacity: 1}, 300);

        } else {
            $( "#panela" ).animate({opacity: 0}, 20);
            $('#navBtn-a').animate({width: 60}, 100);
            $('#navBtn-a').animate({right: -120}, 100);
            $("#panela" ).position({
                my: "left-30",
                at: "left",
                of: "#navBtn-a"
            });
            $( "#panela" ).animate({opacity: 0}, 100);
        }
        state1 = !state1;  
    });
    
    // slider button 2
    $("#toggle-slide-button-2").click(function () {
        if (state2){
            $('#navBtn-b').animate({right: 40}, 100);
            $('#navBtn-b').animate({width: 230}, 100);
            $("#panelb" ).position({
                my: "center-50",
                at: "center",
                of: "#navBtn-b"
            });
            $( "#panelb" ).animate( {opacity: 1}, 300);

        } else {
            $( "#panelb" ).animate({opacity: 0}, 20);
            $('#navBtn-b').animate({width: 60}, 100);
            $('#navBtn-b').animate({right: -120}, 100);
            $("#panelb" ).position({
                my: "left-30",
                at: "left",
                of: "#navBtn-b"
            });
        }
        state2 = !state2;  
    });

    // slider button 3
    $("#toggle-slide-button-3").on({
        click: function () {
                $('#navBtn-c').animate({right: 40}, 100);
                $('#navBtn-c').animate({width: 230}, 100);
            },
        mouseleave: function() {
                $('#navBtn-c').animate({width: 40}, 100);
                $('#navBtn-c').animate({right: -140}, 100);
            }  
        }
    });


    $('.logo-ethos').on('click', function ( e ) {
        Custombox.open({
            target: '#modal',
            effect: 'slide'
        });
        e.preventDefault();
    });
}


// ---------------- ---------------- Execute ----------------- --------------//
$(document).ready(main);